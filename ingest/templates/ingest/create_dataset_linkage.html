{% extends 'ingest/base.html' %}

{% block content %}
<div class="container">
    <h2>Create Dataset Linkages for {{ collection.name }}</h2>
    <form method="POST">
        {% csrf_token %}
        <table class="table">
            <thead>
                <tr>
                    <th>Dataset Info</th>
                    <th>
                        Code ID
                        <i class="fa fa-info-circle tooltip-trigger" data-toggle="tooltip" data-html="true"
                            title="Select the source of the dataset linkage.">
                        </i>
                    </th>
                    <th>
                        Identifier for Linkage
                        <i class="fa fa-info-circle tooltip-trigger" data-toggle="tooltip" data-html="true" title="<ul>
                                    <li>BIL Dataset Identifier: ace-cat-dog</li>
                                    <li>NeMO Identifier: nemo:dat-4v55t0q</li>
                                    <li>DANDI Identifier: DANDI:000008/0.211014.0809</li>
                                   </ul>">
                        </i>
                    </th>
                    <th>
                        Relationship
                        <i class="fa fa-info-circle tooltip-trigger" data-toggle="tooltip" data-html="true" title="<ul>
                                    <li>Omics Data: for related NeMO datasets</li>
                                    <li>Neurophysiology Data: for related DANDI datasets</li>
                                    <li>Derived Data: for reprocessed or reanalyzed BIL datasets</li>
                                    <li>Raw Data: for raw datasets of previously submitted processed BIL datasets</li>
                                    <li>Neuron Tracing: for neuron tracing datasets of previously submitted BIL datasets</li>
                                   </ul>">
                        </i>
                    </th>
                    <th>
                        Description
                        <i class="fa fa-info-circle tooltip-trigger" data-toggle="tooltip" data-html="true" title="<ul>
                                    <li>Brief description (character limit: X) of the linked dataset</li>
                                    <li>Preferably the title of the linked dataset</li>
                                   </ul>">
                        </i>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for dataset in datasets %}
                <tr>
                    <td>
                        <strong>{{ dataset.title }}</strong><br>
                        <small>BIL Directory: {{ dataset.bildirectory }}</small><br>
                        {% if collection.submission_status == "SUCCESS" and collection.validation_status == "SUCCESS" %}
                        <small>BIL ID: {{ dataset.bil_id|default:"N/A" }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <select name="code_id_{{ dataset.id }}" class="form-control code-id-dropdown"
                            data-dataset-id="{{ dataset.id }}">
                            <option value="">Select Code ID</option>
                            <option value="bil">BIL</option>
                            <option value="nemo">Nemo</option>
                            <option value="dandi">Dandi</option>
                            <option value="cubietissue">CubieTissue</option>
                        </select>
                    </td>
                    <td class="identifier-cell">
                        <input type="text" name="data_id_2_{{ dataset.id }}" id="data_id_2_{{ dataset.id }}"
                            class="form-control identifier-input" placeholder="Data ID 2">
                    </td>
                    <td>
                        <select name="relationship_{{ dataset.id }}" class="form-control">
                            <option value="">Select Relationship</option>
                            <option value="sequence data">Sequence Data</option>
                            <option value="neuron tracing">Neuron Tracing</option>
                            <option value="derived_data">Derived Data</option>
                            <option value="raw">Raw</option>
                            <option value="aligned">Aligned</option>
                        </select>
                    </td>
                    <td>
                        <textarea name="description_{{ dataset.id }}" class="form-control"
                            placeholder="Description"></textarea>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-primary">Submit Linkages</button>
    </form>
</div>

<!-- jQuery, Bootstrap & Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function () {
        // Initialize tooltips for all elements with the data-toggle attribute
        function initializeTooltips() {
            $('[data-toggle="tooltip"]').tooltip({
                html: true, // Allow HTML content in tooltips
                placement: 'bottom'
            });
        }

        // Initialize tooltips on page load
        initializeTooltips();

        $(".code-id-dropdown").change(function () {
            var datasetId = $(this).data("dataset-id");
            var selectedCode = $(this).val();
            var identifierCell = $("#data_id_2_" + datasetId).closest(".identifier-cell");

            if (selectedCode === "bil") {
                // Replace with Select2 dropdown inside the same cell
                identifierCell.html(`
                    <select name="data_id_2_${datasetId}" id="data_id_2_${datasetId}" class="form-control identifier-dropdown"></select>
                `);

                $("#data_id_2_" + datasetId).select2({
                    placeholder: "Search BIL ID or Dataset Title",
                    allowClear: true,
                    width: '100%',
                    ajax: {
                        url: "{% url 'ingest:get_bil_ids' %}",
                        dataType: "json",
                        delay: 250,
                        data: function (params) {
                            return { q: params.term || "" };
                        },
                        processResults: function (data) {
                            return {
                                results: $.map(data, function (item) {
                                    return { id: item.bil_id, text: item.bil_id + (item.dataset_title ? " - " + item.dataset_title : "") };
                                })
                            };
                        }
                    }
                });
            } else {
                // Restore the original text input inside the same cell
                identifierCell.html(`
                    <input type="text" name="data_id_2_${datasetId}" id="data_id_2_${datasetId}" class="form-control identifier-input" placeholder="Data ID 2">
                `);
            }

            // Reinitialize tooltips after dynamic content change
            initializeTooltips();
        });
    });
</script>

{% endblock %}