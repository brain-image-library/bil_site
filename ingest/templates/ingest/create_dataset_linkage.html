{% extends 'ingest/base.html' %}

{% block content %}
<div class="container">
    <h2>Dataset Linkages for {{ collection.name }}</h2>

    {% if existing_linkages %}
    <!-- Display existing linkages -->
    <table class="table">
        <thead>
            <tr>
                <th>Dataset Title</th>
                <th>Code ID</th>
                <th>Identifier for Linkage</th>
                <th>Relationship</th>
                <th>Description</th>
                <th>Linkage Date</th>
            </tr>
        </thead>
        <tbody>
            {% for linkage in existing_linkages %}
            <tr>
                <td>{{ linkage.data_id_1_bil.v2_ds_id.title }}</td>
                <td>{{ linkage.code_id }}</td>
                <td>{{ linkage.data_id_2 }}</td>
                <td>{{ linkage.relationship }}</td>
                <td>{{ linkage.description }}</td>
                <td>{{ linkage.linkage_date }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <!-- Display form if no linkages exist -->
    <form method="POST">
        {% csrf_token %}
        <table class="table">
            <thead>
                <tr>
                    <th>Dataset Info</th>
                    <th>Code ID</th>
                    <th>Identifier for Linkage</th>
                    <th>Relationship</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                {% for dataset in datasets %}
                <tr>
                    <td>
                        <strong>{{ dataset.title }}</strong><br>
                        <small>BIL Directory: {{ dataset.bildirectory }}</small><br>
                        {% if collection.submission_status == "SUCCESS" and collection.validation_status == "SUCCESS" %}
                        <small>BIL ID: {{ dataset.bil_id|default:"N/A" }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <select name="code_id_{{ dataset.id }}" class="form-control code-id-dropdown"
                            data-dataset-id="{{ dataset.id }}">
                            <option value="">Select Code ID</option>
                            <option value="bil">BIL</option>
                            <option value="nemo">Nemo</option>
                            <option value="dandi">Dandi</option>
                            <option value="cubietissue">CubieTissue</option>
                        </select>
                    </td>
                    <td class="identifier-cell" style="width: 250px;">
                        <input type="text" name="data_id_2_{{ dataset.id }}" id="data_id_2_{{ dataset.id }}"
                            class="form-control identifier-input" placeholder="Data ID 2" style="width: 100%;">
                    </td>
                    <td>
                        <select name="relationship_{{ dataset.id }}" class="form-control">
                            <option value="">Select Relationship</option>
                            <option value="sequence data">Sequence Data</option>
                            <option value="neuron tracing">Neuron Tracing</option>
                            <option value="derived_data">Derived Data</option>
                            <option value="raw">Raw</option>
                            <option value="aligned">Aligned</option>
                        </select>
                    </td>
                    <td>
                        <textarea name="description_{{ dataset.id }}" class="form-control"
                            placeholder="Description"></textarea>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-primary">Submit Linkages</button>
    </form>
    {% endif %}
</div>

<!-- jQuery, Bootstrap & Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

<script>
    var preloadedBilIds = {{ bil_id_data| safe }};

    $(document).ready(function () {
            function initializeTooltips() {
                $('[data-toggle="tooltip"]').tooltip({ html: true, placement: 'bottom' });
            }
            initializeTooltips();

            $(".code-id-dropdown").change(function () {
                var datasetId = $(this).data("dataset-id");
                var selectedCode = $(this).val();
                var identifierCell = $("#data_id_2_" + datasetId).closest(".identifier-cell");

                // ðŸ”¹ Always maintain a fixed width (prevents shifting)
                var fixedWidth = "250px";

                // Disable "Select Code ID" after selection
                $(this).find("option[value='']").prop("disabled", true);

                if (selectedCode === "bil") {
                    // ðŸ”¹ Replace input with Select2 dropdown but keep width fixed
                    identifierCell.html(`
                <select name="data_id_2_${datasetId}" id="data_id_2_${datasetId}" 
                    class="form-control identifier-dropdown" style="width: ${fixedWidth};"></select>
            `);

                    $("#data_id_2_" + datasetId).select2({
                        placeholder: "Search BIL ID or Dataset Title",
                        allowClear: true,
                        width: "100%",  // Ensures full width inside the cell
                        minimumInputLength: 2,
                        ajax: {
                            url: "{% url 'ingest:get_bil_ids' %}",
                            dataType: "json",
                            delay: 300,
                            data: function (params) {
                                return { q: params.term || "" };
                            },
                            processResults: function (data) {
                                return {
                                    results: $.map(data, function (item) {
                                        return { id: item.bil_id, text: item.bil_id + (item.dataset_title ? " - " + item.dataset_title : "") };
                                    })
                                };
                            }
                        }
                    });

                } else {
                    // ðŸ”¹ Restore text input while keeping width fixed
                    identifierCell.html(`
                <input type="text" name="data_id_2_${datasetId}" id="data_id_2_${datasetId}" 
                class="form-control identifier-input" placeholder="Data ID 2" style="width: ${fixedWidth};">
            `);
                }

                initializeTooltips();
            });
        });
</script>

{% endblock %}